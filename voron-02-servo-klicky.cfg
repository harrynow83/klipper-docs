[include mainsail.cfg]
[include displayMenu.cfg]
#[include macros.cfg]
#[include homing.cfg]

# This file contains common pin mappings for the BIGTREETECH SKR Pico V1.0
# To use this config, the firmware should be compiled for the RP2040 with
# USB communication.

# The "make flash" command does not work on the SKR Pico V1.0. Instead,
# after running "make", copy the generated "out/klipper.uf2" file
# to the mass storage device in RP2040 boot mode

## Voron Design VORON 0.2 SKR Pico V1.0 config

## *** THINGS TO CHANGE/CHECK: ***
## MCU path                                                                     [mcu] section
## Z and Extruder motor currents                                                [tmc2209 stepper_*] sections. Uncomment the stepper motor you have
## Full steps per rotation for Extruder                                         [extruder] section
## Thermistor types                                                             [extruder] and [heater_bed] sections - See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types
## Motor currents                                                               [extruder] [stepper] and [_HOME_X/Y] macro sections
## PID tune                                                                     [extruder] and [heater_bed] sections
## Fine tune E steps                                                            [extruder] section
## For more info                                                                check https://docs.vorondesign.com/build/startup/#v0

[mcu]
#####################################################################
# Obtain definition by "ls -l /dev/serial/by-id/"
#####################################################################

serial: /dev/serial/by-id/usb-Klipper_rp2040_454741505B85EAFA-if00

restart_method: command

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 70

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 70

[printer]
kinematics: corexy
max_velocity: 300
max_accel: 1000
max_z_velocity: 5
max_z_accel: 300
square_corner_velocity: 4.0

#####################################################################
#      adxl
#####################################################################
[mcu rpi]
serial: /tmp/klipper_host_mcu

[adxl345]
cs_pin: rpi:gpio67 # I m using fluidd, host:gpio67 doesn't allowed me to write so I tried rpi:gpio67 and just worked.
spi_bus: spidev0.0

[resonance_tester]
accel_chip: adxl345
probe_points:
  65, 65, 20

#####################################################################
#      X/Y Stepper Settings
#####################################################################

[stepper_x]
step_pin: gpio11                                       ## Refer to https://docs.vorondesign.com/build/startup/#v0
dir_pin: gpio10                               # Check motor direction in link above. If inverted, add a ! before gpio10
enable_pin: !gpio12
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200                                  # Set to 400 for 0.9¬∞ degree stepper motor, 200 is for 1.8¬∞ stepper motors
endstop_pin: !gpio4
position_endstop: 110
position_max: 110
homing_speed: 20
second_homing_speed: 3.0
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_x]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 0
interpolate: False
run_current: 0.8       
# you need to calculate the run_current value using the equation (rated_motor_current * 0.707 = Maximum_run_current) start with a value that is about 60%-70% of your maximum value.
sense_resistor: 0.110
stealthchop_threshold: 999999             # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle
#diag_pin: ^gpio4    	   # YOU NEED TO JUMP THIS DIAG PIN ON YOUR BOARD FOR SENSORLESS HOMING TO WORK 
#driver_SGTHRS: 40 				# this is set to 255 which is the MAX sensitivity for sensorless homing, you will need to tune this later
hold_current: 0.40

[stepper_y]
step_pin: gpio6
dir_pin: gpio5
enable_pin: !gpio7
rotation_distance: 40
microsteps: 32
full_steps_per_rotation: 200

endstop_pin: ^!gpio3
position_endstop: 110
position_max: 110

homing_speed: 40
second_homing_speed: 10
homing_retract_dist: 5
homing_positive_dir: true

[tmc2209 stepper_y]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 2
interpolate: False
run_current: 0.80
hold_current: 0.55
sense_resistor: 0.110
stealthchop_threshold: 999999

#####################################################################
#   Z Stepper Settings
#####################################################################

[stepper_z]
step_pin: gpio19
dir_pin: !gpio28                   # Remove the ! before gpio28 if motor direction is inverted.
enable_pin: !gpio2
rotation_distance: 8                # For T8x8 integrated lead screw
microsteps: 32
endstop_pin: ^gpio25
position_endstop: 118             # ‚Üê ¬°Este par√°metro es obligatorio!
position_max: 118
position_min: -1.5
homing_speed: 30
second_homing_speed: 3.0
homing_retract_dist: 5

[tmc2209 stepper_z]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 1
interpolate: False
## For OMC (StepperOnline) 17LS13-0404E-200G 0.4A 
run_current: 0.743
## For LDO-42STH25-1004CL200E 1.0A
#run_current: 0.37
sense_resistor: 0.110
stealthchop_threshold: 999999          # Set to 999999 to turn stealthchop on, and 0 to use spreadcycle
driver_SGTHRS: 80
hold_current: 0.45

#####################################################################
#   Extruder
#####################################################################
[extruder]
step_pin: gpio14
dir_pin: gpio13                                                     # Add ! if moving opposite direction
enable_pin: !gpio15
rotation_distance: 26.98                   # See calibrating rotation_distance on extruders doc
gear_ratio: 50:10                                                   # For Mini Afterburner
microsteps: 32
nozzle_diameter: 0.400
Filament_diameter: 1.750
heater_pin: gpio23
sensor_type:Generic 3950
sensor_pin: gpio27
min_temp: 0
max_temp: 270

min_extrude_temp: 170
max_extrude_only_distance: 101
max_extrude_cross_section: 0.8
pressure_advance: 0.0                                               # See tuning pressure advance doc
pressure_advance_smooth_time: 0.040

#full_steps_per_rotation: 200                      # Set to 200 for LDO 1.8¬∞ stepper motor, and set to 400 for OMC(StepperOnline) 0.9¬∞ stepper motor
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for NTC 100k 3950 thermistors

#control: pid                                                        # Do PID calibration after initial checks
#pid_Kp: 28.182
#pid_Ki: 1.978
#pid_Kd: 100.397

[tmc2209 extruder]
uart_pin: gpio9
tx_pin: gpio8
uart_address: 3
interpolate: False
run_current: 0.8 # for LDO 36STH20-1004AHG
sense_resistor: 0.110
stealthchop_threshold: 0                                            # Set to 0 for spreadcycle, avoid using stealthchop on extruder


[probe]
pin: ^!gpio22
x_offset: 0     # luego recalibras distancia con respecto a la boquilla
y_offset: 13      # luego recalibras distancia con respecto a la boquilla
z_offset: -2      # luego recalibras  distancia con respecto a la boquilla
speed: 5.0
samples: 3
samples_result: median
sample_retract_dist: 5.0
lift_speed: 10

#####################################################################
#   Bed Heater
#####################################################################

[heater_bed]
heater_pin: gpio21
## Check what thermistor type you have. See https://www.klipper3d.org/Config_Reference.html#common-thermistors for common thermistor types.
## Use "Generic 3950" for Keenovo heaters

sensor_type:Generic 3950
sensor_pin: gpio26
smooth_time: 3.0
#max_power: 0.6                                                     # Only needed for 100w pads
min_temp: 0
max_temp: 120
#control: pid                                                         # Do PID calibration after initial checks
#pid_Kp: 52.00
#pid_Ki: 0.77
#pid_Kd: 406.00

#####################################################################
# Fan Control
#####################################################################

[heater_fan hotend_fan]
pin: gpio18
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
#fan_speed: 1.0                                                     # You can't PWM the delta fan unless using blue wire

[fan]
pin: gpio17
max_power: 1.0
kick_start_time: 0.5                                                # Depending on your fan, you may need to increase this value if your fan will not start
off_below: 0.13
cycle_time: 0.010

[controller_fan MCU_fan]
pin: gpio20
max_power: 1.0
kick_start_time: 0.5
heater: extruder
#fan_speed: 1.0 

#####################################################################
#   Filament Runout Sensor
#####################################################################

[filament_switch_sensor RUNOUT]
pause_on_runout: True
runout_gcode: PAUSE
switch_pin: !gpio16

#####################################################################
# Neopixel
#####################################################################

[neopixel board_rgb]
pin: gpio24
chain_count: 1
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.1
initial_BLUE: 0.0

#####################################################################
#   V0 Display
#####################################################################
[mcu display]
serial: /dev/serial/by-id/usb-Klipper_stm32f042x6_25000C001843304754393320-if00
restart_method: command

[display]
lcd_type: sh1106
i2c_mcu: display
i2c_bus: i2c1a
# # Set the direction of the encoder wheel
##Standard: Right (clockwise) scrolls down or increases values. Left (counter-clockwise scrolls up or decreases values.
encoder_pins: ^display:PA3, ^display:PA4
# #   Reversed: Right (clockwise) scrolls up or decreases values. Left (counter-clockwise scrolls down or increases values.
# #encoder_pins: ^display:PA4, ^display:PA3
click_pin: ^!display:PA1
kill_pin: ^!display:PA5
x_offset: 1
# #   Use X offset to shift the display towards the right. Value can be 0 to 3
vcomh: 31
# #   Set the Vcomh value on SSD1306/SH1106 displays. This value is
# #   associated with a "smearing" effect on some OLED displays. The
# #   value may range from 0 to 63. Default is 0.
# #   Adjust this value if you get some vertical stripes on your display. (31 seems to be a good value)

[neopixel displayStatus]
pin: display:PA0
chain_count: 1
color_order: GRB
initial_RED: 0.05
initial_GREEN: 0.05
initial_BLUE: 0.5

#####################################################################
# Macros
#####################################################################

[gcode_macro LOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E30 F300                    ; load
   G1 E15 F150                    ; prime nozzle with filament
   M82                            ; set extruder to absolute
    
[gcode_macro UNLOAD_FILAMENT]
gcode:
   M83                            ; set extruder to relative
   G1 E10 F300                    ; extrude a little to soften tip
   G1 E-40 F1800                  ; retract some, but not too much or it will jam
   M82                            ; set extruder to absolute

[gcode_macro _HOME_Z]
gcode:
    G90
    G28 Z
    G1 Z30


[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT_RATIO = 0.7 %} # by default we are dropping the motor current during homing. you can adjust this value if you are having trouble with skipping while homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT_RATIO * RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT_RATIO * RUN_CURRENT_Y}

    # Home
    G28 X
    # Move away
    G91
    G1 X-10 F1200
    
    # Wait for StallGuard registers to clear
    M400
    G90
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT_RATIO = 0.7 %} # by default we are dropping the motor current during homing. you can adjust this value if you are having trouble with skipping while homing
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT_RATIO * RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT_RATIO * RUN_CURRENT_Y}

    # Home
    G28 Y
    # Move away
    G91
    G1 Y-10 F1200

    # Wait for StallGuard registers to clear
    M400
    G90
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

    
[gcode_macro MOVE_WITHOUT_HOMING]
gcode:
    SET_KINEMATIC_POSITION X={X} Y={Y} Z={Z}
    G1 X={TO_X} Y={TO_Y} Z={TO_Z} F={F}
    
    description: "Mover los ejes sin homing previo"
    X: 0
    Y: 0
    Z: 0
    TO_X: 0
    TO_Y: 0
    TO_Z: 0
    F: 3000

[gcode_macro TEST_FAN_ON]
description: "Enciende ventilador de capa al 100%"
gcode:
    M106 S255
    RESPOND PREFIX="üåÄ FAN" MSG="Ventilador encendido al 100%"

[gcode_macro TEST_FAN_OFF]
description: "Apaga ventilador de capa"
gcode:
    M107
    RESPOND PREFIX="üßä FAN" MSG="Ventilador apagado"

[gcode_macro TEST_FAN_CYCLE]
description: "Ciclo gradual del ventilador de capa"
gcode:
    RESPOND PREFIX="üîÑ FAN" MSG="Iniciando ciclo gradual"
    M106 S64    ; 25%
    G4 S2
    M106 S128   ; 50%
    G4 S2
    M106 S192   ; 75%
    G4 S2
    M106 S255   ; 100%
    G4 S3
    M107
    RESPOND PREFIX="‚úÖ FAN" MSG="Ciclo completado"

[gcode_macro HEAT_PREP]
description: "Calienta hotend a 200‚ÄØ¬∞C y cama a 100‚ÄØ¬∞C al mismo tiempo"
gcode:
    M104 S200             ; Calienta hotend a 200¬∞C sin esperar
    M140 S100             ; Calienta cama a 100¬∞C sin esperar
    M190 S100             ; Espera a que la cama llegue a 100¬∞C
    M109 S200             ; Espera a que el hotend llegue a 200¬∞C

#[gcode_macro PRINT_START]
#gcode:
    #G4 P2000                      ; Espera 2 segundos (por si hubo desactivaci√≥n de motores)
   # SET_TMC_FIELD STEPPER=stepper_x FIELD=sg_result VALUE=0
  #  G28                      ; Usa el macro que reinicia driver y hace G28
  #  G90
   # G1 Z20 F3000


# mis macros chatgpt

[gcode_macro START_PRINT]
description: "Inicio seguro de impresi√≥n con homing, calentamiento, cebado y primera capa al 25%"
gcode:
    SET_TMC_FIELD STEPPER=stepper_x FIELD=sg_result VALUE=0

    M117 Iniciando impresi√≥n...
    
    G90                              ; Coordenadas absolutas
    M84                              ; Apaga motores por seguridad
    G28                              ; Homing completo

    # (Opcional) Nivelado de cama
    # BED_MESH_PROFILE LOAD=default

    # Establecer temperaturas (desde slicer o por defecto)
    M104 S{params.EXTRUDER_TEMP|default(200)}
    M140 S{params.BED_TEMP|default(60)}

    # Espera hasta alcanzar temperaturas
    M190 S{params.BED_TEMP|default(60)}
    M109 S{params.EXTRUDER_TEMP|default(200)}

    # Mover a posici√≥n segura
    G1 Z5 F2000
    G1 X0 Y5 F6000

    # Cebado de boquilla
    G92 E0
    G1 E5 F200
    G1 X60 E10 F600
    G1 E-1 F1800
    G1 Z0.3 F1000

    # Reducci√≥n de velocidad para primera capa
    M220 S25                       ; 25% de velocidad

    # Espera unos segundos para terminar la primera capa (ajustable)
    G4 S60                         ; Espera 60 segundos (aprox. duraci√≥n primera capa)

    M220 S100                      ; Restaurar velocidad al 100%

    M117 Imprimiendo...

[gcode_macro PRINT_END]
description: G-code seguro para finalizar impresi√≥n
gcode:
    M104 S0                       ; Apagar hotend
    M140 S0                       ; Apagar cama
    G91                           ; Coordenadas relativas
    G1 Z10 F600                   ; Subir Z para evitar colisiones
    G90                           ; Coordenadas absolutas
    G1 X5 Y110 F6000              ; Mover cabezal al frente izquierdo
    M106 S0                       ; Apagar ventilador de capa
    M84                           ; Desactivar motores


[gcode_macro BED_CORNER_INSPECTION_V02]
description: "Voron 0.2 - Revisi√≥n de 5 puntos de la cama con pausa"
gcode:
    {% if printer.toolhead.homed_axes|length < 3 %}
        G28
    {% endif %}
    G1 Z5 F300
    G1 X10 Y10 F6000
    G1 Z1 F300
    G4 P10000
    G1 Z5 F300
    G1 X105 Y10 F6000
    G1 Z1 F300
    G4 P10000
    G1 Z5 F300
    G1 X105 Y105 F6000
    G1 Z1 F300
    G4 P10000
    G1 Z5 F300
    G1 X10 Y105 F6000
    G1 Z1 F300
    G4 P10000
    G1 Z5 F300
    G1 X57 Y57 F6000
    G1 Z1 F300
    G4 P10000
    G1 Z5 F300
    M117 Revisi√≥n completada


[bed_screws]
# Tornillo izquierdo - esquina inferior izquierda
screw1: 5, 110     # X bajo, Y bajo

# Tornillo derecho - esquina inferior derecha
screw2: 100, 105    # X alto, Y bajo

# Tornillo central delantero- parte superior central
screw3: 60, 0   # X medio, Y alto

# ================================
# Voron 02 + Klicky Probe + Servo
# Placa: BTT SKR Pico
# ================================

# --- SERVO CONFIG ---
[servo klicky_servo]
pin: gpio29                         # Pin de servo SKR Pico
maximum_servo_angle: 180
minimum_pulse_width: 0.0005
maximum_pulse_width: 0.0025
initial_angle: 0                   # posici√≥n inicial (dock cerrado)




# ================================
# MACROS DEL SERVO / KLICKY PROBE
# ================================

[gcode_macro KLICKY_UNDOCK]
gcode:
    G90

    # Seguridad en Z
    G1 Z20 F600

    # Ir al servo (frontal derecha)
    G1 Y10 F3000

    # Abrir servo
    SET_SERVO SERVO=klicky_servo ANGLE=90
    G4 P800

    # Mover a la izquierda para enganchar Klicky
    G1 X10 F3000

    # Cerrar servo (fuera del √°rea de la cama)
    SET_SERVO SERVO=klicky_servo ANGLE=0
    G4 P500
    SET_SERVO SERVO=klicky_servo ANGLE=0 WIDTH=0

[gcode_macro KLICKY_DOCK]
gcode:
    G90

    # Seguridad en Z
    G1 Z20 F600

    # Abrir servo
    SET_SERVO SERVO=klicky_servo ANGLE=90
    G4 P800

    # Mover a la derecha para dejar Klicky
    G1 X100 F3000

    # Cerrar servo
    SET_SERVO SERVO=klicky_servo ANGLE=0
    G4 P500
    SET_SERVO SERVO=klicky_servo ANGLE=0 WIDTH=0



# --- SERVO POSITION ---

[gcode_macro _KLICKY_POS]
variable_safe_z: 40

variable_servo_y: 10        # Y del servo (frontal)
variable_dock_x: 10        # X del dock (derecha)
variable_mesh_start_x: 15   # frontal izquierda
variable_mesh_start_y: 15

gcode:
    ; Macro contenedor de variables (no ejecutar nada)


# ================================
# MACRO UNIFICADO PARA PROBE + BED MESH
# ================================


[gcode_macro KLICKY_BED_MESH]
gcode:
    G90

    # Homing obligatorio
    G28

    # Recoger Klicky
    KLICKY_UNDOCK

    # Ejecutar mesh
    BED_MESH_CALIBRATE

    # Ir a la posicion (frontal izquierda)
    G1 X0 Y0 Z20 F3000

    # Devolver Klicky
    KLICKY_DOCK

    # Posici√≥n lista para imprimir
    G1 Z20 F600

    G1 Z0 F600
  
# ================================
# bed mesh
# ================================

[bed_mesh]
speed: 120
horizontal_move_z: 15
mesh_min: 15, 15          # esquina segura considerando offset Y-10
mesh_max: 100, 100        # opuesta (m√°x. √°rea cama, deja margen de 10 mm)
probe_count: 5, 5
fade_start: 1.0
fade_end: 15.0
fade_target: 0
algorithm: bicubic


# ================================
# FIN DE CONFIGURACI√ìN
# ================================

#[include V0Display.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 54.616
#*# pid_ki = 3.139
#*# pid_kd = 237.578
#*#
#*# [stepper_z]
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 36.290
#*# pid_ki = 3.226
#*# pid_kd = 102.067
#*#
#*# [input_shaper]
#*# shaper_type_x = 3hump_ei
#*# shaper_freq_x = 55.0
#*# shaper_type_y = 2hump_ei
#*# shaper_freq_y = 39.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  10.136250, 10.128750, 10.133750, 10.106250, 10.068750
#*# 	  10.136250, 10.128750, 10.121250, 10.110000, 10.092500
#*# 	  10.156250, 10.146250, 10.136250, 10.116250, 10.091250
#*# 	  10.166250, 10.168750, 10.147500, 10.145000, 10.101250
#*# 	  10.165000, 10.172500, 10.160000, 10.152500, 10.126250
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 100.0
#*# min_y = 15.0
#*# max_y = 100.0
